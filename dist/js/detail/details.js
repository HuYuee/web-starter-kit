define(["jquery","util","template","artDialog","solazy"],function(e,t,a,i){e("body").css("visibility","visible");var o={init:function(){var e=this;e.domRender(),e.tabNav(),e.handleEvent(),o.timer=!1},artDialog:function(){var t=function(){var t=e(".customerName").val(),a=e(".telephone").val();return e(".dialog-ul .item-right").on("focus",function(){e(this).removeClass("error-input"),e(".errorinfo").html("")}),""==t?(e(".customerName").addClass("error-input"),e(".errorinfo").html('<span><img src="/market/market/src/images/detail-image/errorinfo-error.png" />用户名不能为空!</span>'),!1):""==a?(e(".telephone").addClass("error-input"),e(".errorinfo").html('<span> <img src="/market/market/src/images/detail-image/errorinfo-error.png" />手机号不能为空！</span>'),!1):/^1[34578]\d{9}$/.test(a)?void 0:(e(".telephone").addClass("error-input"),e(".errorinfo").html('<span> <img src="/market/market/src/images/detail-image/errorinfo-error.png" />手机号格式不正确！</span>'),!1)};e(".consultation").on("click",function(){var a=e(".pubMod .contact li").eq(-2).find("span").text(),i=dialog({title:" ",fixed:!0,modal:!0,backdropBackground:"#000",backdropOpacity:.4,okValue:"提交",ok:function(){if(0==t())return!1;o.submitCustomer()},content:' <ul class="dialog-ul"><li class="desc">您好，欢迎咨询客服获取产品报价！<br>您可以拨打'+a+'<br>或留下您的联系方式，我们会尽快与您取得联系：<br></li><li class="errorinfo"></li><li class="dialog-ul-item"><input id="customerName"  type="text" class="item-right customerName" placeholder="您怎么称呼？"></li><li class="dialog-ul-item"><input id="telephone"  type="text" class="item-right telephone"  placeholder="您的联系方式？"></li><li class="dialog-ul-item"><input class="item-right mail"  placeholder="您的邮箱？"></li><li class="dialog-ul-item"><input class="item-right companyName" placeholder="您所在的公司？"></li><li class="dialog-ul-item"><input class="item-right job"  placeholder="还需要什么帮助，您可以写在这里。"></li></ul>'});i.show(),o.d=i})},submitCustomer:function(){var a=t.getRestful(),i=a[0],r={customerName:encodeURI(e(".customerName").val()),telephone:e(".telephone").val(),email:e(".mail").val(),companyName:encodeURI(e(".companyName").val()),job:encodeURI(e(".job").val()),productId:i};e.ajax({url:t.marketServer+"/market/public/customer",data:r,type:"post",dataType:"JSON",success:function(e){e.status&&o.d.close(),o.showCustomerMsg(e.msg)},error:function(){o.showCustomerMsg("保存出现异常!")}})},showCustomerMsg:function(e){var t=dialog({content:e});t.show(),setTimeout(function(){t.close().remove()},2e3)},tabNav:function(){e(".tabs-link").fixedNav()},timerRequest:function(e){e||(e=300),clearTimeout(o.timer),o.timer=setTimeout(function(){o.timer=!1,o.totalPrice()},300)},spinner:function(){new RegExp("^[0-9]*$");e(".input-group-addon").on("click",function(t){var a=e(t.target);if(e(a).hasClass("spin-up")){var i=e(a).parents(".spinner").find("input"),r=parseInt(e(i).val());if(r<e(i).data("max"))e(i).val(r+1),e(i).data("autonegotiable")&&r>=e(i).data("min")-1&&o.showBuyButton(!0);else if(e(i).data("autonegotiable"))return o.showBuyButton(!1),e(i).val(r+1),!1}else if(e(a).hasClass("spin-down")){var i=e(a).parents(".spinner").find("input"),r=parseInt(e(i).val());if(r>e(i).data("min")&&r-1<=e(i).data("max"))o.showBuyButton(!0),e(i).val(r-1);else if(e(i).data("autonegotiable")&&r>0)return o.showBuyButton(!1),e(i).val(r-1),!1}o.timerRequest()}),e(".form-control").on("keypress keyup",function(t){var a=t.keyCode||t.charCode;if("keyup"===t.type&&(8==a||46==a)){var i=parseInt(e(this).val());return isNaN(i)||i<e(this).data("min")?(e(this).data("autonegotiable")&&o.showBuyButton(!1),e(".buybutton").attr("disabled","disabled").css("background-color","#e8e8e8")):(e(this).data("autonegotiable")&&o.showBuyButton(!0),e(".buybutton").removeAttr("disabled").css("background-color","#DD3730")),o.timerRequest(800),!0}if("keypress"===t.type&&8!=a&&46!=a){o.showBuyButton(!0);var r=[];if(a<48||a>57)return!1;var n=e(this).val();if(this.selectionEnd==this.selectionStart){if(r.push(n),r.push(String.fromCharCode(a)),isNaN(r.join("")))return e(this).val(e(this).data("min")),!1}else r.push(n.substring(0,this.selectionStart)),r.push(String.fromCharCode(a)),r.push(n.substring(this.selectionEnd,n.length));var i=parseInt(r.join(""));return i>e(this).data("max")?!!e(this).data("autonegotiable")&&(o.showBuyButton(!1),!0):i<e(this).data("min")?(e(this).data("autonegotiable")&&o.showBuyButton(!1),e(".buybutton").attr("disabled","disabled").css("background-color","#e8e8e8"),!0):(o.timerRequest(800),e(".buybutton").removeAttr("disabled").css("background-color","#DD3730"),!0)}if(32==a||13==a||16==a)return e(this).val(e(this).data("min")),!1})},totalPrice:function(t){var a=this.getPriceURL();e.ajax({type:"get",url:a,dataType:"JSONP",success:function(t){e(".detail-price").text(t.price)}})},getPriceURL:function(){var a=e(".specification").find(".on").parent(),i=a.data("id"),r=a.data("spec"),n=t.marketServer+"/market/productSpeci/priceCalculate?productId="+i+"&pkSpecification="+r;if(o.saleMode){n+="&lease="+e(".pul-cycle li").find(".on").data("cycle")}if(o.multiAccount){n+="&count="+e(".account").find(".active").find("input").val()}return n},domRender:function(){if(t.isDev){var i=t.getRequset(),r=t.marketServer+"/market/product/saleInfo/"+i.id;t.productId=i.id}else{var n=t.getRestful(),r=t.marketServer+"/market/product/saleInfo/"+n[0];t.productId=n[0]}e.ajax({type:"get",url:r,dataType:"JSONP",error:function(){e(".lazybox").soLazy()},success:function(t){if(e(".lazybox").soLazy(),t.status){if(a.helper("specLeaseHelper",function(e){var t="";return"1"==e?t="1月":"3"==e?t="3月":"6"==e?t="6月":"12"==e?t="1年":"24"==e?t="2年":"36"==e?t="3年":console.error("未找到对应的周期!"),t}),3!=t.data.specification[0].saleMode){var i=a("spec",t.data);e(".order-wrap").html(i)}if(e(".order-wrap").css("display","block"),!o.hasAutoNegotiable(t.data.specification)){var r=null;r=2==t.data.specification[0].saleMode?a("priceTableOne",t.data):a("priceTable",t.data),e(".price-table").html(r)}o.spinner();var n=t.data.specification[0].saleMode,s=t.data.specification[0].multiAccount;1==n||"1"==n?o.saleMode=!0:(o.saleMode=!1,e(".cycle").css("display","none")),1==s||"1"==s?o.multiAccount=!0:e(".account").css("display","none"),e(".specification").find("li").eq(0).find("a").addClass("on"),e(e(".pul-cycle")[0]).addClass("active").find("li").eq(0).find("a").addClass("on"),e(e(".account-number")[0]).addClass("active"),o.totalPrice(),o.recommendProduct(),e(".specification li").on("click",function(){var t=e(this).index();e(this).parents("ul").find(".on").removeClass("on"),e(this).find("a").addClass("on"),e(".pul-cycle").removeClass("active").find(".on").removeClass("on"),e(e(".pul-cycle")[t]).addClass("active").find("li").eq(0).find("a").addClass("on"),e(".account-number").removeClass("active");var a=e(e(".account-number")[t]).addClass("active").find("input"),i=a.val();i=parseInt(i),isNaN(i)&&a.val(a.data("min")),o.saleMode&&(isNaN(i)||i<a.data("min"))?e(".buybutton").attr("disabled","disabled").css("background-color","#e8e8e8"):e(".buybutton").removeAttr("disabled").css("background-color","#DD3730"),o.showBuyButton(!0),a.data("autonegotiable")&&(isNaN(i)||i>a.data("max")||i<a.data("min"))&&o.showBuyButton(!1),o.totalPrice()}),e(".pul-cycle li").on("click",function(){e(this).parent().find(".on").removeClass("on"),e(this).find("a").addClass("on"),o.totalPrice()}),e(".buybutton").on("click",function(){o.orderconfirm()}),e("#obtain").on("click",function(){o.postMail()})}}})},hasAutoNegotiable:function(t){var a=!1;if(!t&&0==t.length)return!1;if(3==t[0].saleMode)a=!0;else for(var i=0,r=t.length;i<r;i++)if(1==t[i].autoNegotiable){a=!0;break}return a&&(o.artDialog(),e("#pric .grid-show").text("此商品支持定制化，请联系服务商洽谈后确定相应方案和报价")),a},postMail:function(){var a=/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/,i=e.trim(e("#email").val());if(a.test(i)){var r=encodeURI(t.productId);url=t.marketServer+"/market/product/productDataEmail?emailAddress="+i+"&productId="+r,e.ajax({url:url,dataType:"JSONP",type:"get",success:function(e){o.showDialog("您申请的资料已经通过邮件发送，请点击邮件中的链接进行下载。")},error:function(){o.showDialog("邮件发送失败!")}})}else o.showDialog("您输入的邮箱格式不正确，请重新输入！")},orderconfirm:function(){if(isNaN(parseInt(e(".detail-price").text().trim())))return!1;var a="";if(o.verificaUser()){var i=t.marketServer+"/market/orderconfirm?",r=encodeURI(e(".view-info h1").text().trim()),n=encodeURI(e(".specification .on").text().trim()),s=encodeURI(e(".cycle .on").data("cycle")),c=encodeURI(e(".detail-price").text().trim());a=i+"productId="+encodeURI(e(".specification .on").parent().data("id"))+"&pkSpecifications="+encodeURI(e(".specification .on").parent().data("spec"))+"&urlProductName="+r+"&urlProductSpecification="+n+"&urlProductLease="+s+"&urlProductPrice="+c+"&urlCount="+encodeURI(e(".account").find(".active").find("input").val()),window.location.href=a}},recommendProduct:function(){e.ajax({type:"get",url:t.marketServer+"/market/productrecommend/products/"+t.productId+"/similarproduct",dataType:"JSONP",success:function(t){if(t.status){var i=a("telproduct",t);e(".telproducts").html(i),""==i&&e(".telproducts").parents(".pubMod").css("display","none")}}})},verificaUser:function(){if(!t.loginStat){var e=t.marketServer+"/market/jump.jsp?target=",a=t.URLencode(window.location.href);return url=e+a,window.location.href=url,!1}return!0},showDialog:function(t){dialog({content:t,quickClose:!0}).show(e(".search-form")[0])},handleEvent:function(){e(".pdf-download").click(function(a){o.verificaUser()?e.ajax({type:"get",url:t.marketServer+"/market/product/"+t.productId+"/productguid",dataType:"JSONP",success:function(e){e.status},error:function(e){}}):a.preventDefault()})},downloadFile:function(e){try{var t=document.createElement("a");document.body.appendChild(t),t.href=e,t.target="_new",t.click(),document.body.removeChild(t)}catch(e){console.error(e)}},getNegotiableDesc:function(){e.ajax({type:"get",url:t.marketServer+"/market/productSpeci/negotiableDesc?productId="+t.productId,dataType:"JSONP",success:function(t){t.status&&e(".tiper").find("span").text(t.negotiableDesc)},error:function(e){}})},showBuyButton:function(t){t?(e(".buybutton").css("display","block"),e(".consultation").css("display","none"),e(e(".price").find("em")[0]).text("￥")):(e(".buybutton").css("display","none"),e(".consultation").css("display","block"),e(".detail-price").parent().find("em").text(""),e(".detail-price").text("价格面议"))}};e(function(){o.init(),e(".pul_one li").on("click",function(){e(this).find("a").addClass("on").parent().siblings().find("a").removeClass("on")})})});